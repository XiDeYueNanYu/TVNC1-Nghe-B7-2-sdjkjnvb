<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm viewport để tối ưu hóa di động -->
    <title>越南语听力练习</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 300px; /* Mặc định cho màn hình lớn */
            background-color: #f7fbf3; /*f7fbf3  3f4040*/
        }
        #gameContainer {
            display: block;
            min-height: calc(100vh - 150px); /* Đảm bảo nội dung chiếm đủ chiều cao màn hình */
        }
        #infoBox { 
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 2px solid #91b66f; /*041b31 1f4263*/
            background: #85ae5f; /*ecf2e4 fefefc*/
            color: #ffffff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #91b66f; 
            background: #85ae5f; 
            color: #f1c232; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #instructionBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 2px solid #91b66f; 
            background: #85ae5f; 
            color: #f7e19c; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #controls { 
            position: fixed; /* Cố định ở cuối màn hình */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px; /* Giới hạn chiều rộng tối đa */
            background: #f7fbf3;
                        border: 3px solid #f7fbf3;                        
            padding: 10px 0; 
           /* box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); */
            z-index: 1000; 
        }
        #controls div {
            margin: 5px 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button { 
            padding: 8px 8px; 
            margin: 0 5px; 
            cursor: pointer; 
            border: 2px solid #85ae5f; 
            background: #85ae5f; /*192332*/
                        box-shadow: 0 5px 5px rgba(0, 0, 0, 0.2);
            color: #fffbef; 
            font-size: 28px; 
            border-radius: 5px; 
        }
        #sentenceNumber { 
            width: 50px; 
            padding: 10px; 
            text-align: center; 
            border: 3px solid #85ae5f; /*041b31 68838B*/
            background: #f1cc76; 
            color: #000; 
            border-radius: 10px; 
            font-size: 16px; 
            -moz-appearance: textfield; 
        }
        #sentenceNumber::-webkit-inner-spin-button, 
        #sentenceNumber::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        #sentenceNumber:disabled { 
            background: #eee; 
        }
        .disabled { 
            cursor: not-allowed; 
            pointer-events: none; 
        }
        .active-mode { 
            border: 2px solid #fed16a; 
        }
        #indicator { 
            width: 95%;
                        max-width: 700px; 
            min-height: 50px; 
            margin: 10px auto; 
                        padding: 5px;
            border: 3px solid #fed16a; 
            background: #ffffe0; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        #optionsContainer {
            width: 100%;
            max-width: 700px;
            margin: 10px auto;
        }
        .optionBtn {
            width: 95%; 
            max-width: 700px;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #ffffff;
            background: #ffffff; /*E6EDD9*/
            color: #000000;
                        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 30px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
        }
        .optionBtn:hover {
            background: #D2E4C4;
        }
        .correct {
            background: #B7D7AA !important;
        }
        .wrong {
            background: #CE6D5E !important;
        }
        #score { 
            display: none; 
            width: 100%;
            max-width: 700px;
            margin: 10px auto; 
            color: #FF6820; 
            font-size: 30px; 
            text-align: center;
        }
        #wrongSentences { 
            display: none; 
            width: 95%; 
            max-width: 700px; 
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #CE6D5E; 
            background: #FFF0F0; 
            color: #CE6D5E; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
        }
        #results { 
            display: none; 
            width: 95%;
            max-width: 700px;        
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #734A2E; 
            background: #fffbef; 
            color: #000; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
            white-space: pre-line;
        }

        /* Media query cho thiết bị di động */
        @media (max-width: 768px) {
            body {
                padding-bottom: 200px; /* Giảm padding-bottom cho điện thoại */
            }
            #controls {
                padding: 5px 0; /* Giảm padding */
            }
            button {
                padding: 6px 6px; /* Giảm kích thước nút */
                font-size: 20px; /* Giảm kích thước chữ */
            }
            #sentenceNumber {
                width: 40px; /* Giảm chiều rộng */
                padding: 8px; /* Giảm padding */
                font-size: 14px; /* Giảm kích thước chữ */
            }
            .optionBtn {
                font-size: 20px; /* Giảm kích thước chữ cho đáp án */
                padding: 8px; /* Giảm padding */
            }
            #infoBox {
                font-size: clamp(30px, 4vw, 40px); /* Giảm kích thước chữ */
            }
            #contactBox, #instructionBox {
                font-size: clamp(14px, 2vw, 16px); /* Giảm kích thước chữ */
            }
            #indicator {
                min-height: 40px; /* Giảm chiều cao tối thiểu */
            }
            #results, #wrongSentences, #score {
                font-size: 24px; /* Giảm kích thước chữ */
                                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>听力练习</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">选择与播放内容相符的选项</div>
        <div id="indicator"></div>
        <div id="optionsContainer"></div>
        <div id="results"></div>
        <div id="score">0/0</div>
        <div id="wrongSentences"></div>
    </div>
    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric" pattern="[0-9]*">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>
    <audio id="mainAudio" src="audio.mp3"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>
        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const replayBtn = document.getElementById('replayBtn');
        const freeModeBtn = document.getElementById('freeModeBtn');
        const testModeBtn = document.getElementById('testModeBtn');
        const autoContinueBtn = document.getElementById('autoContinueBtn');
        const showHideBtn = document.getElementById('showHideBtn');
        const scoreDisplay = document.getElementById('score');
        const wrongSentencesDisplay = document.getElementById('wrongSentences');
        const optionsContainer = document.getElementById('optionsContainer');
        const resultsDisplay = document.getElementById('results');

        const buttons = [prevBtn, nextBtn, replayBtn, freeModeBtn, testModeBtn, autoContinueBtn, showHideBtn];


const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 0.309,
        "end": 4.139,
        "correctAnswer": "Tôi làm việc ở đây không phải chỉ vì tiền mà là vì đam mê.",
        "translation": "我在这里工作，不仅是为了钱，而是出于热情。",
        "options": [
            "Tôi làm việc ở đây không phải chỉ vì tiền mà là vì đam mê.",
            "Tội làm việc ở đây không phải chỉ vì tiền mà là vì đam mê.",
            "Tôi làm việc ở dây không phải chỉ vì tiền mà là vì đam mê.",
            "Tôi làm việc ở đây không phải chỉ vì tiên mà là vì đam mê."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 4.939,
        "end": 8.639,
        "correctAnswer": "Cô ấy khóc không phải chỉ vì buồn mà là vì thất vọng.",
        "translation": "她哭，不仅是因为伤心，而是因为失望。",
        "options": [
            "Cô ấy khóc không phải chỉ vì buồn mà là vì thất vọng.",
            "Cô ấy khóc không phải chỉ vì bường mà là vì thất vọng.",
            "Cô ấy khót không phải chỉ vì buồn mà là vì thất vọng.",
            "Cô ấy khóc không phải chỉ vì buồn mà là vì thắt vọng."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 9.959,
        "end": 15.299,
        "correctAnswer": "Anh ta nghỉ việc không phải chỉ vì lương thấp mà là vì môi trường làm việc thiếu chuyên nghiệp.",
        "translation": "他辞职不仅是因为工资低，而是因为工作环境不专业。",
        "options": [
            "Anh ta nghỉ việc không phải chỉ vì lương thấp mà là vì môi trường làm việc thiếu chuyên nghiệp.",
            "Oanh ta nghỉ việc không phải chỉ vì lương thấp mà là vì môi trường làm việc thiếu chuyên nghiệp.",
            "Anh ta nghỉ việc không phải chỉ vì lương tháp mà là vì môi trường làm việc thiếu chuyên nghiệp.",
            "Anh ta nghỉ việc không phải chỉ vì lương thấp mà là vì môi trường làm viết thiếu chuyên nghiệp."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 16.669,
        "end": 21.619,
        "correctAnswer": "Cô ấy học tiếng Việt không phải chỉ vì thi mà là vì muốn khám phá văn hóa.",
        "translation": "她学越南语不仅是为了考试，而是为了探索文化。",
        "options": [
            "Cô ấy học tiếng Việt không phải chỉ vì thi mà là vì muốn khám phá văn hóa.",
            "Cô ấy học tiến Việt không phải chỉ vì thi mà là vì muốn khấm phá văn hóa.",
            "Cô ấy học tiếng Việt không phải chỉ vì thi mà là vì muốn khấm phá văn hóa.",
            "Cô ấy học tiếng Việt không phải chỉ vì thi mà là vì muốn khớm hóa văn hóa."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 23.319,
        "end": 26.099,
        "correctAnswer": "Cô ấy không những xinh đẹp mà còn thông minh.",
        "translation": "她不仅漂亮，而且聪明。",
        "options": [
            "Cô ấy không những xinh đẹp mà còn thông minh.",
            "Cô ấy không những xinh đẹp mà còn thống minh.",
            "Cô ấy không nhũng xinh đẹp mà còn thông minh.",
            "Cô ấy không những sinh đẹp mà còn thông minh."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 27.259,
        "end": 30.339,
        "correctAnswer": "Cậu ấy không những học giỏi mà còn rất chăm chỉ.",
        "translation": "他不仅学习好，而且很用功。",
        "options": [
            "Cậu ấy không những học giỏi mà còn rất chăm chỉ.",
            "Cậu ấy không những học giỏi mà còn rất cham chỉ.",
            "Gậu ấy không những học giỏi mà còn rất chăm chỉ.",
            "Cậu ấy không những học giỏi mà còn rất chăm chí."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 31.479,
        "end": 34.769,
        "correctAnswer": "Cô ấy không những biết nói tiếng Việt mà còn viết khá tốt.",
        "translation": "她不仅会说越南语，而且写得也很好。",
        "options": [
            "Cô ấy không những biết nói tiếng Việt mà còn viết khá tốt.",
            "Cô ấy không những biết nỗi tiếng Việt mà còn viết khá tốt.",
            "Cô ấy không những biết nói tiểng Việt mà còn viết khá tốt.",
            "Cô ấy không những biết nói tiếng Việt mà còn viết khả tốt."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 35.999,
        "end": 40.619,
        "correctAnswer": "Bài hát này không những giai điệu hay mà ca từ còn rất có ý nghĩa.",
        "translation": "这首歌不仅旋律好，歌词也很有意义。",
        "options": [
            "Bài hát này không những giai điệu hay mà ca từ còn rất có ý nghĩa.",
            "Bài hát này không những giai điểu hay mà ca từ còn rất có ý nghĩa.",
            "Bài hát này không những giai điệu hay mà ga từ còn rất có ý nghĩa.",
            "Bài hát này không những giai điệu hay mà ca từ còn rất có ý nghịa."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 41.949,
        "end": 45.019,
        "correctAnswer": "Không chỉ tôi, cả anh ấy cũng không biết chuyện này.",
        "translation": "不仅我，他也不知道这件事。",
        "options": [
            "Không chỉ tôi, cả anh ấy cũng không biết chuyện này.",
            "Không chỉ tôi, cả anh ấy cũng không biết chuyển này.",
            "Khôn chỉ tôi, cả anh ấy cũng không biết chuyện này.",
            "Không chỉ tôi, cả anh đấy cũng không biết chuyện này."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 46.439,
        "end": 48.929,
        "correctAnswer": "Cả cô giáo cũng ngạc nhiên trước kết quả.",
        "translation": "连老师都对结果感到惊讶。",
        "options": [
            "Cả cô giáo cũng ngạc nhiên trước kết quả.",
            "Cả cô giáo cũng ngạc nhiền trước kết quả.",
            "Cả cô ráo cũng ngạc nhiên trước kết quả.",
            "Cả cô giáo cũng ngạc nhiên trước két quả."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 50.299,
        "end": 53.439,
        "correctAnswer": "Không chỉ bạn, cả tôi cũng không hiểu tại sao.",
        "translation": "不仅你，我也不明白为什么。",
        "options": [
            "Không chỉ bạn, cả tôi cũng không hiểu tại sao.",
            "Không chỉ bạn, cả tôi cũng không hiểu tại xao.",
            "Không chỉ bạn, cả tôi củng không hiểu tại sao.",
            "Không chị bạn, cả tôi cũng không hiểu tại sao."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 54.819,
        "end": 56.859,
        "correctAnswer": "Cả trẻ con cũng hiểu điều đó.",
        "translation": "连小孩也明白那件事。",
        "options": [
            "Cả trẻ con cũng hiểu điều đó.",
            "Cả trẻ côn cũng hiểu điều đó.",
            "Cả trẻ con cũng hiểu diều đó.",
            "Cả trẻ con cũng hiểu điểu đó."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 58.149,
        "end": 61.309,
        "correctAnswer": "Không chỉ anh ấy, cả chị ấy cũng không đến dự tiệc.",
        "translation": "不仅他，连她也没来参加聚会。",
        "options": [
            "Không chỉ anh ấy, cả chị ấy cũng không đến dự tiệc.",
            "Không chỉ anh ấy, cả chị ấy cũng không đến dự tệc.",
            "Không chỉ anh ấy, cả chí ấy cũng không đến dự tệc.",
            "Khôn chỉ anh ấy, cả chị ấy cũng không đến dự tiệc."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 62.729,
        "end": 64.509,
        "correctAnswer": "Cô ấy đáng được khen ngợi.",
        "translation": "她值得被表扬。",
        "options": [
            "Cô ấy đáng được khen ngợi.",
            "Cô ấy đáng đượk khen ngợi.",
            "Cô ấy đáng được khen người.",
            "Cô ấy gô ấy đáng được khen ngợi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 65.769,
        "end": 67.629,
        "correctAnswer": "Anh ta đáng bị phê bình.",
        "translation": "他应该被批评。",
        "options": [
            "Anh ta đáng bị phê bình.",
            "Oanh ta đáng bị phê bình.",
            "Anh ta đáng bị phê bính.",
            "Anh ta đáng bị pê bình."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 68.889,
        "end": 70.689,
        "correctAnswer": "Bộ phim này rất đáng xem.",
        "translation": "这部电影非常值得一看。",
        "options": [
            "Bộ phim này rất đáng xem.",
            "Bộ phin này rất đáng xem.",
            "Bộ phim này rất đáng xemh.",
            "Bồ phim này rất đáng xem."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 71.669,
        "end": 73.859,
        "correctAnswer": "Câu hỏi đó đáng để suy nghĩ.",
        "translation": "那个问题值得思考。",
        "options": [
            "Câu hỏi đó đáng để suy nghĩ.",
            "Câu hỏi đó đáng để xuy nghĩ.",
            "Câu hỏi đó đắng để suy nghĩ.",
            "Câu hỏi đó đáng để xuy ngỉ."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 75.259,
        "end": 77.189,
        "correctAnswer": "Cuốn sách này rất đáng mua.",
        "translation": "这本书非常值得买。",
        "options": [
            "Cuốn sách này rất đáng mua.",
            "Cuốn xách này rất đáng mua.",
            "Cuốn sách này rất đáng mưa.",
            "Cuốn sách náy rất đáng mua."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 78.229,
        "end": 80.409,
        "correctAnswer": "Ý kiến của bạn đáng được cân nhắc.",
        "translation": "你的意见值得考虑。",
        "options": [
            "Ý kiến của bạn đáng được cân nhắc.",
            "Ý kiến của bạn đáng được câng nhắc.",
            "Ý kến của bạn đáng được cân nhấc.",
            "Ý kến của bạn đáng được cân nhắc."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 81.759,
        "end": 83.929,
        "correctAnswer": "Thành tích đó rất đáng tự hào.",
        "translation": "那个成绩非常值得自豪。",
        "options": [
            "Thành tích đó rất đáng tự hào.",
            "Thành tích đó rất đáng tự hàu.",
            "Thành tích đó rất đắng tự hào.",
            "Thành tịch đó rất đáng tự hào."
        ]
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let correctCount = 0;
        let isPlaying = false;
        let correctSentences = new Set();
        let wrongSentences = new Set();
        let autoContinue = false;
        let showAnswer = false;
        let userAnswers = [];

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function init() {
            updateSentenceDisplay();
        }

        function updateSentenceDisplay() {
            sentenceNumber.value = currentIndex + 1;
            indicator.style.background = '#ffffe0';
            if (isFreeMode && showAnswer) {
                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #85ae5f;">${sentences[currentIndex].translation}</div>
                `;
            } else {
                indicator.innerHTML = '';
            }
            updateOptions();
            if (!isFreeMode) updateScore();
        }

        function updateOptions() {
            optionsContainer.innerHTML = '';
            const shuffledOptions = shuffleArray(sentences[currentIndex].options);
            shuffledOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'optionBtn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(btn);
            });
        }

        function playCurrentSentence() {
            if (isPlaying) audio.pause();
            buttons.forEach(btn => btn.classList.add('disabled'));
            sentenceNumber.disabled = true;
            isPlaying = true;
            audio.src = sentences[currentIndex].audioFile;
            audio.currentTime = sentences[currentIndex].start;
            audio.play().catch(error => {
                console.error('Audio playback failed:', error);
                alert('Vui lòng nhấn nút “再听一遍” để phát âm thanh.');
                buttons.forEach(btn => btn.classList.remove('disabled'));
                sentenceNumber.disabled = false;
                isPlaying = false;
            });

            audio.ontimeupdate = () => {
                if (audio.currentTime >= sentences[currentIndex].end) {
                    audio.pause();
                    audio.ontimeupdate = null;
                    buttons.forEach(btn => btn.classList.remove('disabled'));
                    sentenceNumber.disabled = false;
                    isPlaying = false;
                }
            };
        }

        function moveSentence(direction) {
            currentIndex = (currentIndex + direction + sentences.length) % sentences.length;
            updateSentenceDisplay();
            playCurrentSentence();
        }

        function checkAnswer(selectedAnswer) {
            const correctAnswer = sentences[currentIndex].correctAnswer;
            const optionButtons = optionsContainer.getElementsByClassName('optionBtn');
            
            // Clear previous styles
            for (let btn of optionButtons) {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = !isFreeMode; // Only disable buttons in Test Mode
            }

            // Find and style the selected button
            for (let btn of optionButtons) {
                if (btn.textContent === selectedAnswer) {
                    if (selectedAnswer === correctAnswer) {
                        indicator.style.background = '#B7D7AA';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('correct');
                        correctAudio.play().catch(error => {
                            console.error('Correct audio playback failed:', error);
                        });
                    } else {
                        indicator.style.background = '#CE6D5E';
                                                indicator.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #000000;">${sentences[currentIndex].translation}</div>
                `;
                        btn.classList.add('wrong');
                        wrongAudio.play().catch(error => {
                            console.error('Wrong audio playback failed:', error);
                        });
                    }
                }
            }

            if (!isFreeMode) {
                userAnswers[currentIndex] = selectedAnswer;
                if (selectedAnswer === correctAnswer && !correctSentences.has(currentIndex)) {
                    correctCount++;
                    correctSentences.add(currentIndex);
                    wrongSentences.delete(currentIndex);
                } else if (selectedAnswer !== correctAnswer && !correctSentences.has(currentIndex)) {
                    wrongSentences.add(currentIndex);
                }
                updateScore();

                // Auto-move to next sentence in Test Mode
                const audioToWait = (selectedAnswer === correctAnswer) ? correctAudio : wrongAudio;
                audioToWait.onended = () => {
                    if (userAnswers.length === sentences.length) {
                        showResults();
                    } else {
                        setTimeout(() => {
                            moveSentence(1);
                        }, 200);
                    }
                };
            } else if (isFreeMode && autoContinue && selectedAnswer === correctAnswer) {
                // Auto-move in Free Mode only if answer is correct and autoContinue is enabled
                correctAudio.onended = () => {
                    setTimeout(() => {
                        moveSentence(1);
                    }, 200);
                };
            } else {
                correctAudio.onended = null;
                wrongAudio.onended = null;
            }
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
            scoreDisplay.style.display = 'block'; // Hiển thị score trong Test Mode
        }

        function showResults() {
            let resultText = `练习完成！\n正确答案数量：${correctCount}/${sentences.length}\n正确率：${((correctCount / sentences.length) * 100).toFixed(2)}%\n错误题目：`;
            wrongSentences.forEach(index => {
                resultText += `\n第${index + 1}题：\n你的选择：${userAnswers[index] || '未选择'}\n正确答案：${sentences[index].correctAnswer}\n`;
            });
            if (wrongSentences.size === 0) {
                resultText += '\n全部正确！';
            }
            resultsDisplay.textContent = resultText;
            resultsDisplay.style.display = 'block';
        }

        prevBtn.onclick = () => {
            moveSentence(-1);
        };

        nextBtn.onclick = () => {
            moveSentence(1);
        };

        replayBtn.onclick = () => {
            playCurrentSentence();
        };

        freeModeBtn.onclick = () => {
            isFreeMode = true;
            freeModeBtn.classList.add('active-mode');
            testModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = false;
            autoContinueBtn.classList.remove('disabled');
            showHideBtn.disabled = false;
            showHideBtn.classList.remove('disabled');
            scoreDisplay.style.display = 'none';
            wrongSentencesDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateSentenceDisplay();
        };

        testModeBtn.onclick = () => {
            isFreeMode = false;
            testModeBtn.classList.add('active-mode');
            freeModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = true;
            autoContinueBtn.classList.add('disabled');
            showHideBtn.disabled = true;
            showHideBtn.classList.add('disabled');
            showHideBtn.classList.remove('active-mode');
            showAnswer = false;
            scoreDisplay.style.display = 'block';
            currentIndex = 0;
            correctCount = 0;
            correctSentences.clear();
            wrongSentences.clear();
            userAnswers = [];
            for (let i = 0; i < sentences.length; i++) {
                wrongSentences.add(i);
            }
            updateSentenceDisplay();
        };

        autoContinueBtn.onclick = () => {
            if (isFreeMode) {
                autoContinue = !autoContinue;
                autoContinueBtn.classList.toggle('active-mode');
                if (!autoContinue) {
                    correctAudio.onended = null;
                }
            }
        };

        showHideBtn.onclick = () => {
            if (isFreeMode) {
                showAnswer = !showAnswer;
                showHideBtn.classList.toggle('active-mode');
                updateSentenceDisplay();
            }
        };

        sentenceNumber.onchange = () => {
            if (!isPlaying) {
                const num = parseInt(sentenceNumber.value) - 1;
                if (!isNaN(num) && num >= 0 && num < sentences.length) {
                    currentIndex = num;
                    updateSentenceDisplay();
                    playCurrentSentence();
                } else {
                    alert(`输入范围： 1 到 ${sentences.length}`);
                    updateSentenceDisplay();
                }
            }
        };

        sentenceNumber.onkeydown = (e) => {
            if (!isPlaying) {
                if (e.key === 'ArrowLeft') {
                    moveSentence(-1);
                }
                if (e.key === 'ArrowRight') {
                    moveSentence(1);
                }
            }
        };

        init();
    </script>
</body>
</html>
